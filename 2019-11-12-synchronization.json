{"version":2,"kind":"Article","sha256":"24c6a58baab89fd9457faa04c41963d2d741d9d53ae3d980f3b70a04aa592e53","slug":"2019-11-12-synchronization","location":"/CS2112/2019-11-12-synchronization.md","dependencies":[],"frontmatter":{"title":"Synchronization","tags":["Cornell","19FA","CS2112"],"date":"2019-11-12","authors":[{"nameParsed":{"literal":"Yao Lirong","given":"Yao","family":"Lirong"},"name":"Yao Lirong","affiliations":["Cornell University"],"url":"https://yao-lirong.github.io","linkedin":"https://www.linkedin.com/in/yao-lirong/","id":"contributors-myst-generated-uid-0"}],"keywords":["Cornell","CS","Yao Lirong"],"affiliations":[{"id":"Cornell University","name":"Cornell University"}],"numbering":{"title":{"offset":1}},"exports":[{"format":"md","filename":"2019-11-12-synchronization.md","url":"/cornell-notes/build/2019-11-12-synchroni-9308545f68add35b2e6237b69a17f547.md"}]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"From Lecture: ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"b2xbZIxHSM"},{"type":"link","url":"https://www.cs.cornell.edu/courses/cs2112/2019fa/lectures/lecture.html?id=synchronization","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Synchronization","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"PduQ834VPJ"}],"urlSource":"https://www.cs.cornell.edu/courses/cs2112/2019fa/lectures/lecture.html?id=synchronization","key":"WkMZaEdWrH"}],"key":"SiXBBoXbA3"},{"type":"thematicBreak","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"WhaF9JJtnV"},{"type":"heading","depth":2,"position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"Monitor","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"Mv2zllGPID"}],"identifier":"monitor","label":"Monitor","html_id":"monitor","implicit":true,"key":"nfQoZR5I05"},{"type":"paragraph","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"idea: object state guarded by its mutex","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"Rs7fSBOke0"}],"key":"NBKfWPNf0w"},{"type":"paragraph","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"monitor is just a class, whose all public methods “synchronize,” which means you can’t access state without holding mutex","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"ufKhTlgrL0"}],"key":"e370vaohO5"},{"type":"paragraph","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"text","value":"Principal: let short methods hold the mutex in case it doesn’t affect performance","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"rbYbMyVP5w"}],"key":"gkfXdNDL8O"},{"type":"comment","value":"more","key":"O6bdShBuQj"},{"type":"code","lang":"java","value":"T1: add(elem)\nT2: size(); contains(elem);","position":{"start":{"line":24,"column":1},"end":{"line":27,"column":1}},"key":"x1rqkxLSzm"},{"type":"paragraph","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"text","value":"when ","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"QP8DdzrV9M"},{"type":"inlineCode","value":"elem","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"HOuOOzWgcv"},{"type":"text","value":" is added, it may not be seen in size. So ","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"zJoqenFsE9"},{"type":"inlineCode","value":"add","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"dZt5kbvq6u"},{"type":"text","value":" should be written as ","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"yyJPauq26n"},{"type":"inlineCode","value":"synchronized add (T elem) {}","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"pxkSrwXXIU"}],"key":"lggGuGikvO"},{"type":"thematicBreak","position":{"start":{"line":31,"column":1},"end":{"line":31,"column":1}},"key":"avgKtmP73V"},{"type":"heading","depth":3,"position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"children":[{"type":"text","value":"Locks & Deadlock","position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"key":"O7p2Hk2sMb"}],"identifier":"locks-deadlock","label":"Locks & Deadlock","html_id":"locks-deadlock","implicit":true,"key":"d6PbtuSDa3"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":35,"column":1},"end":{"line":38,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":35,"column":1},"end":{"line":36,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"children":[{"type":"strong","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"children":[{"type":"text","value":"Lock","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"QLRMfmlg2V"}],"key":"A7Gr9xsfX9"},{"type":"text","value":" is achieved by a mutex","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"Pff0kuuKLN"}],"key":"EY2HrIHek2"}],"key":"mygfA3GNHw"},{"type":"listItem","spread":true,"position":{"start":{"line":37,"column":1},"end":{"line":38,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"children":[{"type":"strong","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"children":[{"type":"text","value":"deadlocks","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"W0R5WDBOQY"}],"key":"g9FzBJTRPi"},{"type":"text","value":" happen when all threads end up being blocked by a mutex","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"wpCJ9swwEj"}],"key":"of4dt38lCx"}],"key":"GU2NSTlw8e"}],"key":"XV8vcEXUCc"},{"type":"heading","depth":4,"position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"children":[{"type":"text","value":"e.g.","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"uIIn8am9PV"}],"identifier":"e-g","label":"e.g.","html_id":"e-g","implicit":true,"key":"lLxvuDeAIZ"},{"type":"code","lang":"java","value":"class a{\n    synchronized f(){ b.g();}\n}\nclass b{\n    synchronized g() { a.f() }\n}","position":{"start":{"line":41,"column":1},"end":{"line":48,"column":1}},"key":"O9ceo6CeKH"},{"type":"code","lang":"java","value":"T1: a.f() ---> b.g()\nT2: b.g() ---> a.f()","position":{"start":{"line":50,"column":1},"end":{"line":53,"column":1}},"key":"kEgSMFe05A"},{"type":"paragraph","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"children":[{"type":"text","value":"Say we first go into T1, we acquire a; Then before going into ","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"key":"i1tklErxqm"},{"type":"inlineCode","value":"b.g()","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"key":"ENRulDqICU"},{"type":"text","value":" in T1, we acquire ","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"key":"Arx4GMrD97"},{"type":"inlineCode","value":"b.g()","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"key":"S2r8WSP3iu"},{"type":"text","value":" in T2. Then we get into a deadlock cause we can’t get ","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"key":"FiuWINy8Pa"},{"type":"inlineCode","value":"b.g()","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"key":"RI1qSSvA4g"},{"type":"text","value":" in ","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"key":"ql6JiGzbF3"},{"type":"inlineCode","value":"a.f()","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"key":"RYkyCrPm3N"},{"type":"text","value":" nor vice versa.","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"key":"PljfVHzHY6"}],"key":"VxexqSiKvf"},{"type":"paragraph","position":{"start":{"line":57,"column":1},"end":{"line":57,"column":1}},"children":[{"type":"text","value":"That’s because we wrote a lock acquisition order in cycle","position":{"start":{"line":57,"column":1},"end":{"line":57,"column":1}},"key":"ngwtIXyjAX"}],"key":"gfUzJcyZaT"},{"type":"thematicBreak","position":{"start":{"line":59,"column":1},"end":{"line":59,"column":1}},"key":"nBX3YFgy7j"},{"type":"heading","depth":4,"position":{"start":{"line":61,"column":1},"end":{"line":61,"column":1}},"children":[{"type":"text","value":"Solution:","position":{"start":{"line":61,"column":1},"end":{"line":61,"column":1}},"key":"F2L1foOLvW"}],"identifier":"solution","label":"Solution:","html_id":"solution","implicit":true,"key":"in07adglGN"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":63,"column":1},"end":{"line":74,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":63,"column":1},"end":{"line":64,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":63,"column":1},"end":{"line":63,"column":1}},"children":[{"type":"text","value":"no cycle","position":{"start":{"line":63,"column":1},"end":{"line":63,"column":1}},"key":"NNtd6CnXFo"}],"key":"ojpIAbdvMX"}],"key":"Mg858mH7mF"},{"type":"listItem","spread":true,"position":{"start":{"line":65,"column":1},"end":{"line":70,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":65,"column":1},"end":{"line":65,"column":1}},"children":[{"type":"text","value":"write an order in which to acquire mutex","position":{"start":{"line":65,"column":1},"end":{"line":65,"column":1}},"key":"zmWPevjLXP"}],"key":"W10golrPvZ"},{"type":"paragraph","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"children":[{"type":"text","value":"e.g. ","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"fy4amoINSF"},{"type":"inlineCode","value":"a<b","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"l0ZaeolnbE"},{"type":"text","value":": can’t acquire ","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"EyIaP28BHi"},{"type":"inlineCode","value":"a","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"qEjEbsIOVr"},{"type":"text","value":" after ","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"L3Im9K9Whh"},{"type":"inlineCode","value":"b","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"LBgBkla7Xb"},{"type":"text","value":" (which makes ","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"psu31jIbll"},{"type":"inlineCode","value":"b.g()","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"aa7CwcMCtQ"},{"type":"text","value":" illegal)","position":{"start":{"line":67,"column":1},"end":{"line":67,"column":1}},"key":"KzRdPqZk18"}],"key":"YQtrlXEaJb"},{"type":"paragraph","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"children":[{"type":"text","value":"And then write a spec ","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"rEXBalpCO6"},{"type":"inlineCode","value":"/** Requires: lock level < a */","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"FbEpMTk992"}],"key":"dCTv8Mws5D"}],"key":"ufCMdwaQig"},{"type":"listItem","spread":true,"position":{"start":{"line":71,"column":1},"end":{"line":74,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"children":[{"type":"text","value":"acquire mutex in the same order (T1: A,B; T2: A,B instead of T2: B,A)","position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"key":"GspbKmI0E2"}],"key":"vrhHOPhdDu"}],"key":"JuKa3dxyDp"}],"key":"aL753AYVbk"},{"type":"heading","depth":2,"position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"children":[{"type":"text","value":"Barriers","position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"key":"pKd4TuDhP6"}],"identifier":"barriers","label":"Barriers","html_id":"barriers","implicit":true,"key":"AV6fdrPT4n"},{"type":"paragraph","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"children":[{"type":"text","value":"in scientific computation, there are many computations embarrassingly parallel","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"FdAtcZAxAL"}],"key":"XabbIKlSdG"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":79,"column":1},"end":{"line":81,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"children":[{"type":"text","value":"span N threads and wait until they are all done","position":{"start":{"line":79,"column":1},"end":{"line":79,"column":1}},"key":"tFz1QPbNaf"}],"key":"H4FoDDq4pm"},{"type":"listItem","spread":true,"position":{"start":{"line":80,"column":1},"end":{"line":81,"column":1}},"children":[{"type":"text","value":"updates before barrier will be seen by all threads after the barrier","position":{"start":{"line":80,"column":1},"end":{"line":80,"column":1}},"key":"jyKddjgKq4"}],"key":"LlKMs9pDWs"}],"key":"BCyhDWkmwd"},{"type":"code","lang":"java","value":"b = new CyclicBarrier(N); // N is the number of threads(without R/W sharing)\n// after each thread finishes executing, it will wait(), until all threads are done\n// (the barrier blocks everything until N await() are called)","position":{"start":{"line":82,"column":1},"end":{"line":86,"column":1}},"key":"Jm6U958jYC"},{"type":"heading","depth":2,"position":{"start":{"line":90,"column":1},"end":{"line":90,"column":1}},"children":[{"type":"text","value":"Blocking Abstractions","position":{"start":{"line":90,"column":1},"end":{"line":90,"column":1}},"key":"Z5wZHxbhNI"}],"identifier":"blocking-abstractions","label":"Blocking Abstractions","html_id":"blocking-abstractions","implicit":true,"key":"wVI7TbsBXe"},{"type":"paragraph","position":{"start":{"line":92,"column":1},"end":{"line":92,"column":1}},"children":[{"type":"text","value":"How to build your own threads-blocking abstractions?","position":{"start":{"line":92,"column":1},"end":{"line":92,"column":1}},"key":"IKwd7YbbKm"}],"key":"eIyAymR3FK"},{"type":"heading","depth":3,"position":{"start":{"line":94,"column":1},"end":{"line":94,"column":1}},"children":[{"type":"text","value":"e.g.","position":{"start":{"line":94,"column":1},"end":{"line":94,"column":1}},"key":"eC3GBgDnV2"}],"identifier":"e-g","label":"e.g.","html_id":"e-g-1","implicit":true,"key":"ETpAttIDVL"},{"type":"code","lang":"java","value":"/** computes two threads seperately and then add them together*/\nclass WorkerPair extends Runnable\n{\n    int done=0; // # threads done (0~2)\n    Object result;\n    \n    WorkerPair(){\n        new Thread(this).start();\n        new Thread(this).start();\n    }\n    \n    public void run(){\n    \trealDoWork(); //TODO implement this\n    \tsynchronized(this){ // Why not put a synchronized around run()? because then only one thread will really realDoWork();\n    \t\tdone++;\n    \t\tresult = something;\n    \t}\n    }\n    \n    Object getResult(){\n    \twhile(done<2){...}\n    \treturn result;\n    }\n    \n}","position":{"start":{"line":96,"column":1},"end":{"line":122,"column":1}},"key":"JJ2GHAh25L"},{"type":"heading","depth":3,"position":{"start":{"line":124,"column":1},"end":{"line":124,"column":1}},"children":[{"type":"text","value":"Condition Variables","position":{"start":{"line":124,"column":1},"end":{"line":124,"column":1}},"key":"bkKogakYq8"}],"identifier":"condition-variables","label":"Condition Variables","html_id":"condition-variables","implicit":true,"key":"hUZpUvDDcO"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":126,"column":1},"end":{"line":129,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":126,"column":1},"end":{"line":126,"column":1}},"children":[{"type":"text","value":"allow you to block things until some condition is true","position":{"start":{"line":126,"column":1},"end":{"line":126,"column":1}},"key":"j3Du2mBkQm"}],"key":"P1hHS8TZdb"},{"type":"listItem","spread":true,"position":{"start":{"line":127,"column":1},"end":{"line":127,"column":1}},"children":[{"type":"text","value":"a condition variable is always associated with a mutex","position":{"start":{"line":127,"column":1},"end":{"line":127,"column":1}},"key":"VXbo7UtsRA"}],"key":"AO4gf8bwOm"},{"type":"listItem","spread":true,"position":{"start":{"line":128,"column":1},"end":{"line":129,"column":1}},"children":[{"type":"text","value":"every Java object has its own condition variable, which ties to its own mutex","position":{"start":{"line":128,"column":1},"end":{"line":128,"column":1}},"key":"ptZKyzqgx8"}],"key":"TEDzOR0fHP"}],"key":"V514rIbKxX"},{"type":"paragraph","position":{"start":{"line":130,"column":1},"end":{"line":130,"column":1}},"children":[{"type":"text","value":"A ","position":{"start":{"line":130,"column":1},"end":{"line":130,"column":1}},"key":"WRnStll74t"},{"type":"inlineCode","value":"notifyAll()","position":{"start":{"line":130,"column":1},"end":{"line":130,"column":1}},"key":"BYg7BTKy7i"},{"type":"text","value":" is sent whenever any of the conditions may become true; threads awakened by ","position":{"start":{"line":130,"column":1},"end":{"line":130,"column":1}},"key":"NKFvhfJNnd"},{"type":"inlineCode","value":"notifyAll()","position":{"start":{"line":130,"column":1},"end":{"line":130,"column":1}},"key":"Fk6aPVgxKB"},{"type":"text","value":" then test to see if their particular condition has become true; otherwise, they go back to sleep.","position":{"start":{"line":130,"column":1},"end":{"line":130,"column":1}},"key":"vIkFE1Xz7d"}],"key":"zfaG32Vpt8"},{"type":"thematicBreak","position":{"start":{"line":132,"column":1},"end":{"line":132,"column":1}},"key":"ElWAFWCEkF"},{"type":"code","lang":"java","value":"/** Effect: blocks thread and releases mutex, wait for some condition to become true\n(note: why should wait() release mutex? Becuase when the program enters this waiting thread, this thread first acquires mutex, so when it begins to wait, it has to release it so other threads can do their work and finally wake it up after done)\n\tRequires: mutex is held*/\nvoid wait();\n\n/** Effect: return all wait() method (Unblocks/Wake up all threads that are waiting)\n\tRequires: mutex held*/\nvoid notifyAll();","position":{"start":{"line":134,"column":1},"end":{"line":143,"column":1}},"key":"ZvsjpeM438"},{"type":"paragraph","position":{"start":{"line":145,"column":1},"end":{"line":145,"column":1}},"children":[{"type":"text","value":"To block until condition is true:","position":{"start":{"line":145,"column":1},"end":{"line":145,"column":1}},"key":"IoNLYmEV49"}],"key":"O3fSc5pWJ1"},{"type":"code","lang":"java","value":"public void run(){\n    realDoWork();\n    synchronized(this){ \n    \tdone++;\n    \tresult = something;\n        notifyAll();\n    }\n}\n\nsynchronized Object getResult(){\n    while(done<2) wait();\n    return result;\n}","position":{"start":{"line":147,"column":1},"end":{"line":161,"column":1}},"key":"oIzT4ISmFS"},{"type":"thematicBreak","position":{"start":{"line":163,"column":1},"end":{"line":163,"column":1}},"key":"fl2jCHUJuj"},{"type":"paragraph","position":{"start":{"line":165,"column":1},"end":{"line":165,"column":1}},"children":[{"type":"inlineCode","value":"while (!condition) wait();","position":{"start":{"line":165,"column":1},"end":{"line":165,"column":1}},"key":"jTQrr01BbF"},{"type":"text","value":" is the most usual way to write a condition variable","position":{"start":{"line":165,"column":1},"end":{"line":165,"column":1}},"key":"DCwcoiZecn"}],"key":"HDi27TO0Ev"},{"type":"paragraph","position":{"start":{"line":167,"column":1},"end":{"line":167,"column":1}},"children":[{"type":"inlineCode","value":"wait()","position":{"start":{"line":167,"column":1},"end":{"line":167,"column":1}},"key":"UFYku2NYY0"},{"type":"text","value":": wait for some condition to be true, which is determined by other threads","position":{"start":{"line":167,"column":1},"end":{"line":167,"column":1}},"key":"mb5q3JAtF0"}],"key":"Cj7ZjgM6Mx"},{"type":"paragraph","position":{"start":{"line":169,"column":1},"end":{"line":169,"column":1}},"children":[{"type":"inlineCode","value":"notifyAll()","position":{"start":{"line":169,"column":1},"end":{"line":169,"column":1}},"key":"Tf0bNEmBr4"},{"type":"text","value":" called after whatever some of the operations already done can probably wake some method up","position":{"start":{"line":169,"column":1},"end":{"line":169,"column":1}},"key":"woa48VLsqk"}],"key":"K1kejMTV4J"}],"key":"Mw9sAL953K"}],"key":"RKU1H8txzz"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Concurrency","url":"/2019-11-07-concurrency","group":"CS2112 Object-Oriented Design (Honors)"},"next":{"title":"Graph Traversal","url":"/2019-11-19-graph-traversal","group":"CS2112 Object-Oriented Design (Honors)"}}},"domain":"http://localhost:3000"}